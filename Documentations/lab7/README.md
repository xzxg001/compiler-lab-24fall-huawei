# Lab 7 实验文档

鸣谢：USTC 张昱老师的毕昇编译课程实验。<http://staff.ustc.edu.cn/~yuzhang/compiler/lectures/bishengLab.pdf>

- [Lab 7 实验文档](#lab-7-实验文档)
  - [0. 前言](#0-前言)
  - [1. 实验框架](#1-实验框架)
  - [2. 运行与调试](#2-运行与调试)
    - [流水线优化](#流水线优化)
    - [浮点精度调优](#浮点精度调优)
  - [3. 提交要求](#3-提交要求)

## 0. 前言

泰山 V110 是华为鲲鹏 920 中采用的基于 ARM 的自研微架构。在毕昇编译器中指定目标微架构为泰山 V110（tsv110）有助于优化代码性能，这是因为毕昇编译器基于LLVM，能够深度理解泰山V110的硬件特性，充分利用其架构优势。泰山V110属于先进的ARM架构，面向高性能计算和高能效场景，具备大量的向量处理单元和扩展的指令集，尤其是面向机器学习和大数据分析等复杂任务。这些指令集和硬件特性在编译阶段得到优化，可以更好地调度指令、减少内存延迟，显著提升运算效率。

通过在毕昇编译器中明确指定目标微架构为泰山V110，编译器可以进行更深层次的代码优化，例如减少不必要的指令、优化数据加载模式，甚至自动化地进行一些常见的算法加速。这使得生成的二进制代码更贴合硬件架构，运行时性能更高，同时也能够更有效地管理能耗。此外，这样的优化不仅有利于单线程性能，还能对多核任务提供更好的并行化支持，整体提升在泰山 V110 微架构上的应用表现。

泰山 V110 微架构优化也[已被合入 LLVM](https://reviews.llvm.org/D53908)，即使不使用毕昇编译器，也可以进行一定的针对性优化。

&nbsp;

浮点数运算在计算机中并非精确的，因为浮点数的表示是有限的，无法精确表示所有的小数。在执行浮点运算时，可能会出现舍入误差。累积较多的舍入误差可能会导致最终的计算结果与期望值有差距。

在编译器优化过程中，浮点数计算的结果可能会因为不同的优化级别而有所不同，这是因为浮点数计算的精度和顺序可能会在编译器优化中被改变。浮点数运算并不像整数运算那样精确，因为浮点数在计算机中是用有限的二进制位表示的，会涉及舍入误差和精度损失。编译器在优化代码时可能会对浮点运算进行重新排序、简化甚至融合（例如使用FMA指令——Fused Multiply-Add）来提高性能，这可能导致最终结果出现细微的差异。

通过使用一些选项，即便在高优化级别（如 `-O2` 或 `-Ofast`）下，也可以强制编译器严格按照代码的书写顺序执行浮点运算。这样可以在一定程度上保持与 `-O0` 类似的结果，减少因优化导致的浮点误差。

## 1. 实验框架

由于华为提供的开发板未采用泰山 V110 微架构，华为方也未提供华为云服务器资源，所以本次实验中仅要求大家了解泰山 V110 微架构优化的原理，感兴趣的同学可以自费租用服务器进行测试，不计入评分标准。

我们设计了一段相对简单的代码，帮助大家理解浮点精度调优，位于 `src/bisheng/fpopt.cpp`。

## 2. 运行与调试

### 流水线优化

为感兴趣的同学提供泰山 V110 的优化选项，即编译时提供下列选项：

```bash
-O2 -march=tsv110
```

### 浮点精度调优

生成 Makefile 后，构建目标 `fpopt_O2`、`fpopt_Ofast` 和 `fpopt_Ofast_fp_control`，然后分别运行：

```bash
make fpopt_O2 fpopt_Ofast fpopt_Ofast_fp_control
./fpopt_O2
./fpopt_Ofast
./fpopt_Ofast_fp_control
```

观察不同优化级别和浮点控制下的输出结果。

## 3. 提交要求

### 目录结构

TODO

### 提交要求和评分标准

**提交要求**：本实验仅需运行上面给出的代码，并在 `Reports/lab7` 中将运行结果和描述填入实验报告。

**评分标准**：实验报告中能体现两个优化效果即给满分，不必须做出解释。
